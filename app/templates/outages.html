{% extends "base.html" %}

{% block title %}Outages - PowerMon{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1 class="display-4">
            <i class="bi bi-exclamation-triangle"></i> Power Outages
        </h1>
        <p class="lead">Historical record of detected power outages</p>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="card-title">{{ outages.total }}</h3>
                <p class="card-text text-muted">Total Outages</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-danger">
            <div class="card-body">
                <h3 class="card-title text-danger">
                    {{ outages.items|selectattr('is_ongoing')|list|length }}
                </h3>
                <p class="card-text text-muted">Ongoing</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                {% set avg_duration = namespace(value=0, count=0) %}
                {% for outage in outages.items %}
                    {% if outage.duration_seconds %}
                        {% set avg_duration.value = avg_duration.value + outage.duration_seconds %}
                        {% set avg_duration.count = avg_duration.count + 1 %}
                    {% endif %}
                {% endfor %}
                {% if avg_duration.count > 0 %}
                    <h3 class="card-title">{{ (avg_duration.value / avg_duration.count / 60)|round|int }}</h3>
                    <p class="card-text text-muted">Avg Duration (min)</p>
                {% else %}
                    <h3 class="card-title">-</h3>
                    <p class="card-text text-muted">Avg Duration</p>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <h3 class="card-title">{{ outages.items|rejectattr('is_ongoing')|list|length }}</h3>
                <p class="card-text text-muted">Resolved</p>
            </div>
        </div>
    </div>
</div>

<!-- Ongoing Outages Alert -->
{% set ongoing = outages.items|selectattr('is_ongoing')|list %}
{% if ongoing %}
<div class="alert alert-danger" role="alert">
    <h4 class="alert-heading">
        <i class="bi bi-exclamation-triangle-fill"></i> Active Power Outage!
    </h4>
    <p>There {% if ongoing|length == 1 %}is{% else %}are{% endif %} currently {{ ongoing|length }} ongoing outage(s).</p>
    <hr>
    {% for outage in ongoing %}
    <div class="mb-2">
        <strong>Outage #{{ outage.id }}</strong><br>
        Started: <span class="local-time" data-utc="{{ outage.started_at.isoformat() }}">
            {{ outage.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
        </span><br>
        Affected Switches: {{ outage.switches_affected|length if outage.switches_affected else 0 }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Outages Table -->
{% if outages.items %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-table"></i> Outage History</h5>
                <span class="badge bg-secondary">Page {{ outages.page }} of {{ outages.pages }}</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Status</th>
                                <th>Started</th>
                                <th>Ended</th>
                                <th>Duration</th>
                                <th>Switches Affected</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for outage in outages.items %}
                            <tr class="{% if outage.is_ongoing %}table-danger{% endif %}">
                                <td>
                                    <strong>#{{ outage.id }}</strong>
                                </td>
                                <td>
                                    {% if outage.is_ongoing %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-exclamation-circle"></i> Ongoing
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Resolved
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="local-time" data-utc="{{ outage.started_at.isoformat() }}">
                                        {{ outage.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                    </span>
                                </td>
                                <td>
                                    {% if outage.ended_at %}
                                        <span class="local-time" data-utc="{{ outage.ended_at.isoformat() }}">
                                            {{ outage.ended_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if outage.duration_seconds %}
                                        {% set hours = (outage.duration_seconds / 3600)|int %}
                                        {% set minutes = ((outage.duration_seconds % 3600) / 60)|int %}
                                        {% set seconds = outage.duration_seconds % 60 %}

                                        {% if hours > 0 %}
                                            {{ hours }}h {{ minutes }}m
                                        {% elif minutes > 0 %}
                                            {{ minutes }}m {{ seconds }}s
                                        {% else %}
                                            {{ seconds }}s
                                        {% endif %}
                                    {% elif outage.is_ongoing %}
                                        {% set duration = (now - outage.started_at).total_seconds() %}
                                        {% set hours = (duration / 3600)|int %}
                                        {% set minutes = ((duration % 3600) / 60)|int %}

                                        <span class="text-danger">
                                            {% if hours > 0 %}
                                                {{ hours }}h {{ minutes }}m
                                            {% else %}
                                                {{ minutes }}m
                                            {% endif %}
                                            (ongoing)
                                        </span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if outage.switches_affected %}
                                        <span class="badge bg-warning text-dark">
                                            {{ outage.switches_affected|length }}
                                            {% if outage.switches_affected|length == 1 %}switch{% else %}switches{% endif %}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">0</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary view-details-btn"
                                            data-outage-id="{{ outage.id }}"
                                            data-bs-toggle="modal"
                                            data-bs-target="#outageModal{{ outage.id }}">
                                        <i class="bi bi-eye"></i> View
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                {% if outages.pages > 1 %}
                <nav aria-label="Outage pagination">
                    <ul class="pagination justify-content-center">
                        <li class="page-item {% if not outages.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('main.outages', page=outages.prev_num) if outages.has_prev else '#' }}">
                                Previous
                            </a>
                        </li>

                        {% for page_num in range(1, outages.pages + 1) %}
                            {% if page_num == outages.page %}
                                <li class="page-item active">
                                    <a class="page-link" href="#">{{ page_num }}</a>
                                </li>
                            {% elif page_num == 1 or page_num == outages.pages or (page_num >= outages.page - 2 and page_num <= outages.page + 2) %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('main.outages', page=page_num) }}">{{ page_num }}</a>
                                </li>
                            {% elif page_num == outages.page - 3 or page_num == outages.page + 3 %}
                                <li class="page-item disabled">
                                    <a class="page-link" href="#">...</a>
                                </li>
                            {% endif %}
                        {% endfor %}

                        <li class="page-item {% if not outages.has_next %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('main.outages', page=outages.next_num) if outages.has_next else '#' }}">
                                Next
                            </a>
                        </li>
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals for Outage Details -->
{% for outage in outages.items %}
<div class="modal fade" id="outageModal{{ outage.id }}" tabindex="-1" aria-labelledby="outageModalLabel{{ outage.id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header {% if outage.is_ongoing %}bg-danger text-white{% else %}bg-primary text-white{% endif %}">
                <h5 class="modal-title" id="outageModalLabel{{ outage.id }}">
                    <i class="bi bi-info-circle"></i> Outage #{{ outage.id }} Details
                </h5>
                <button type="button" class="btn-close {% if outage.is_ongoing or not outage.is_ongoing %}btn-close-white{% endif %}" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Status</h6>
                        <p>
                            {% if outage.is_ongoing %}
                                <span class="badge bg-danger">Ongoing</span>
                            {% else %}
                                <span class="badge bg-success">Resolved</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Started At</h6>
                        <p>
                            <span class="local-time" data-utc="{{ outage.started_at.isoformat() }}">
                                {{ outage.started_at.strftime('%Y-%m-%d %H:%M:%S') }}
                            </span>
                        </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <h6>Ended At</h6>
                        <p>
                            {% if outage.ended_at %}
                                <span class="local-time" data-utc="{{ outage.ended_at.isoformat() }}">
                                    {{ outage.ended_at.strftime('%Y-%m-%d %H:%M:%S') }}
                                </span>
                            {% else %}
                                <span class="text-muted">Still ongoing</span>
                            {% endif %}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <h6>Duration</h6>
                        <p>
                            {% if outage.duration_seconds %}
                                {% set hours = (outage.duration_seconds / 3600)|int %}
                                {% set minutes = ((outage.duration_seconds % 3600) / 60)|int %}
                                {% set seconds = outage.duration_seconds % 60 %}

                                {% if hours > 0 %}
                                    {{ hours }} hours {{ minutes }} minutes
                                {% elif minutes > 0 %}
                                    {{ minutes }} minutes {{ seconds }} seconds
                                {% else %}
                                    {{ seconds }} seconds
                                {% endif %}
                            {% elif outage.is_ongoing %}
                                <span class="text-danger">Ongoing</span>
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12">
                        <h6>Affected Switches</h6>
                        {% if outage.switches_affected %}
                            <div class="list-group">
                                {% for switch_id in outage.switches_affected %}
                                    {% set switch = namespace(obj=None) %}
                                    {% for s in switches if s.id == switch_id %}
                                        {% set switch.obj = s %}
                                    {% endfor %}

                                    <div class="list-group-item">
                                        {% if switch.obj %}
                                            <i class="bi bi-toggles"></i>
                                            <strong>{{ switch.obj.name }}</strong>
                                            <code class="ms-2">{{ switch.obj.ip_address }}</code>
                                        {% else %}
                                            <i class="bi bi-question-circle text-muted"></i>
                                            <span class="text-muted">Switch ID: {{ switch_id }} (deleted)</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">No switches recorded</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% else %}
<div class="row">
    <div class="col-12">
        <div class="alert alert-success text-center">
            <i class="bi bi-check-circle fs-1"></i>
            <h4 class="mt-3">No power outages recorded</h4>
            <p>Your system is running smoothly with no detected outages!</p>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Convert UTC timestamps to relative time
function getRelativeTime(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffSeconds = Math.floor(diffMs / 1000);
    const diffMinutes = Math.floor(diffSeconds / 60);
    const diffHours = Math.floor(diffMinutes / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffSeconds < 60) {
        return diffSeconds <= 1 ? 'just now' : `${diffSeconds} seconds ago`;
    } else if (diffMinutes < 60) {
        return diffMinutes === 1 ? '1 minute ago' : `${diffMinutes} minutes ago`;
    } else if (diffHours < 24) {
        return diffHours === 1 ? '1 hour ago' : `${diffHours} hours ago`;
    } else {
        return diffDays === 1 ? '1 day ago' : `${diffDays} days ago`;
    }
}

function convertTimesToLocal() {
    const timeElements = document.querySelectorAll('.local-time');
    timeElements.forEach(element => {
        const utcTime = element.getAttribute('data-utc');
        if (utcTime) {
            const date = new Date(utcTime);
            element.textContent = getRelativeTime(date);
            element.setAttribute('title', date.toLocaleString());
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Convert times on page load
    convertTimesToLocal();

    // Update times periodically
    setInterval(convertTimesToLocal, 10000);
});
</script>
{% endblock %}
